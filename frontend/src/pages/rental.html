<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rental - Mahika</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/products.css">
</head>
<body>
    <div class="app">
        <div id="announcement-container"></div>
        <div id="header-container"></div>
        <div id="nav-container"></div>

        <div style="padding: 20px 40px; background: #0a0a0a;">
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <button onclick="filterRental('all')" id="btn-all" style="padding: 10px 20px; background: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer;">All Rentals</button>
                <button onclick="filterRental('Rental-Dresses')" id="btn-dresses" style="padding: 10px 20px; background: #1e3a5f; color: #e0e0e0; border: 1px solid #1e3a5f; border-radius: 4px; cursor: pointer;">ðŸ‘— Dresses</button>
                <button onclick="filterRental('Rental-Jewelry')" id="btn-jewelry" style="padding: 10px 20px; background: #1e3a5f; color: #e0e0e0; border: 1px solid #1e3a5f; border-radius: 4px; cursor: pointer;">ðŸ’Ž Jewelry</button>
            </div>
        </div>
        
        <div class="filter-section">
            <div><span id="product-count">0</span> Rental Items</div>
            <select onchange="sortProducts(this.value)">
                <option value="default">Sort By</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
                <option value="name">Name: A to Z</option>
            </select>
        </div>

        <div class="products" id="products-container"></div>
    </div>

    <!-- Component Loader: Use inline for no-server, or component-loader.js when backend is ready -->
    <script src="../js/component-loader-inline.js"></script>
    <!-- <script src="../js/component-loader.js"></script> -->
    <script>
        loadAllComponents('../', true).then(() => {
            // Components loaded, continue with rental page initialization
        });
    </script>
    <script>
        const API_URL = 'http://localhost:8080/api/products';
        let products = [];
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
        let customProducts = JSON.parse(localStorage.getItem('customProducts')) || [];
        let currentRentalFilter = 'all';

        // Add rental products to sample data
        const rentalProducts = [
            {
                id: 1001,
                name: "Orange Designer Dress",
                category: "Rental-Dresses",
                price: 1500,
                stock: 5,
                images: ["../images/rental/dresses/orange1.jpeg", "../images/rental/dresses/orange2.jpeg", "../images/rental/dresses/orange3.jpeg"],
                imageUrl: "../images/rental/dresses/orange1.jpeg",
                sizes: ["S", "M", "L", "XL"]
            },
            {
                id: 1002,
                name: "Blue Elegant Dress",
                category: "Rental-Dresses",
                price: 1800,
                stock: 4,
                images: ["../images/rental/dresses/blue1.jpeg", "../images/rental/dresses/blue2.jpeg", "../images/rental/dresses/blue3.jpeg"],
                imageUrl: "../images/rental/dresses/blue1.jpeg",
                sizes: ["S", "M", "L", "XL"]
            },
            {
                id: 1003,
                name: "Pink Party Dress",
                category: "Rental-Dresses",
                price: 2000,
                stock: 3,
                images: ["../images/rental/dresses/pink1.jpeg", "../images/rental/dresses/pink2.jpeg", "../images/rental/dresses/pink3.jpeg"],
                imageUrl: "../images/rental/dresses/pink1.jpeg",
                sizes: ["S", "M", "L", "XL"]
            },
            {
                id: 1004,
                name: "Bridal Jewelry Set 1",
                category: "Rental-Jewelry",
                price: 2500,
                stock: 2,
                images: ["../images/rental/jwellery/j1.jpeg", "../images/rental/jwellery/j5.jpeg"],
                imageUrl: "../images/rental/jwellery/j1.jpeg",
                sizes: []
            },
            {
                id: 1005,
                name: "Bridal Jewelry Set 2",
                category: "Rental-Jewelry",
                price: 2800,
                stock: 2,
                images: ["../images/rental/jwellery/j6.jpeg", "../images/rental/jwellery/j7.jpeg", "../images/rental/jwellery/j8.jpeg"],
                imageUrl: "../images/rental/jwellery/j6.jpeg",
                sizes: []
            }
        ];

        // Save rental products to localStorage
        customProducts = customProducts.filter(p => !p.category || !p.category.startsWith('Rental-'));
        customProducts = [...customProducts, ...rentalProducts];
        localStorage.setItem('customProducts', JSON.stringify(customProducts));

        async function loadCategoryProducts(...categories) {
            try {
                const response = await fetch(API_URL);
                products = await response.json();
            } catch (error) {
                products = [];
            }
            
            products = [...products, ...customProducts];
            const filtered = products.filter(p => categories.includes(p.category));
            displayProducts(filtered);
            updateCounts();
        }

        function displayProducts(filteredProducts) {
            const container = document.getElementById('products-container');
            document.getElementById('product-count').textContent = filteredProducts.length;
            
            if (filteredProducts.length === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;"><h3>No rental products found</h3></div>';
                return;
            }

            container.innerHTML = filteredProducts.map(product => {
                const images = Array.isArray(product.images) ? product.images : [product.imageUrl];
                const mainImage = images[0];
                const sizes = product.sizes || [];
                const isInWishlist = wishlist.some(item => item.id === product.id);
                return `
                <div class="product-card">
                    <div style="position: relative;">
                        <button class="wishlist-btn" onclick="event.stopPropagation(); toggleWishlist(${product.id})" id="wish-${product.id}">${isInWishlist ? 'â™¥' : 'â™¡'}</button>
                        <img src="${mainImage}" alt="${product.name}" id="img-${product.id}" onclick="viewProduct(${product.id})" style="cursor: pointer;" onerror="this.src='https://via.placeholder.com/300x400/666/fff?text=No+Image'">
                        ${images.length > 1 ? `
                        <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px;">
                            ${images.map((_, idx) => `<span id="dot-${product.id}-${idx}" onclick="changeImage(${product.id}, ${idx})" style="width: 10px; height: 10px; border-radius: 50%; background: ${idx === 0 ? '#4a90e2' : 'rgba(255,255,255,0.5)'}; cursor: pointer; border: 1px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></span>`).join('')}
                        </div>` : ''}
                    </div>
                    <div class="product-info">
                        <h3>${product.name}</h3>
                        <p class="price">â‚¹${product.price}</p>
                        ${sizes.length > 0 ? `<p style="font-size: 0.8rem; color: #888;">Sizes: ${sizes.join(', ')}</p>` : ''}
                        ${product.stock > 0 ? `<button onclick="addToCart(${product.id})" class="add-to-cart-btn">Add to Cart</button>` : '<button disabled class="add-to-cart-btn" style="background: #ccc; cursor: not-allowed;">Out of Stock</button>'}
                    </div>
                </div>
            `}).join('');
        }

        function toggleWishlist(productId) {
            const product = products.find(p => p.id === productId);
            const existingIndex = wishlist.findIndex(item => item.id === productId);
            
            if (existingIndex > -1) {
                wishlist.splice(existingIndex, 1);
            } else {
                wishlist.push(product);
            }
            
            localStorage.setItem('wishlist', JSON.stringify(wishlist));
            updateCounts();
            
            if (currentRentalFilter === 'all') {
                loadCategoryProducts('Rental-Dresses', 'Rental-Jewelry');
            } else {
                loadCategoryProducts(currentRentalFilter);
            }
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({...product, quantity: 1});
            }
            
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCounts();
            alert('Added to cart!');
        }

        function changeImage(productId, imageIndex) {
            const product = products.find(p => p.id === productId);
            if (product && product.images) {
                const images = Array.isArray(product.images) ? product.images : [product.images];
                document.getElementById(`img-${productId}`).src = images[imageIndex];
                
                images.forEach((_, idx) => {
                    const dot = document.getElementById(`dot-${productId}-${idx}`);
                    if (dot) dot.style.background = idx === imageIndex ? '#4a90e2' : 'rgba(255,255,255,0.5)';
                });
            }
        }

        function updateCounts() {
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = cartCount;
            document.getElementById('wishlist-count').textContent = wishlist.length;
        }

        function viewProduct(productId) {
            localStorage.setItem('viewProductId', productId);
            window.location.href = '../index.html';
        }

        function sortProducts(sortBy) {
            let filtered = products.filter(p => 
                currentRentalFilter === 'all' ? 
                (p.category === 'Rental-Dresses' || p.category === 'Rental-Jewelry') : 
                p.category === currentRentalFilter
            );
            
            if (sortBy === 'price-low') {
                filtered.sort((a, b) => a.price - b.price);
            } else if (sortBy === 'price-high') {
                filtered.sort((a, b) => b.price - a.price);
            } else if (sortBy === 'name') {
                filtered.sort((a, b) => a.name.localeCompare(b.name));
            }
            displayProducts(filtered);
        }

        loadCategoryProducts('Rental-Dresses', 'Rental-Jewelry');
        updateCounts();

        function filterRental(type) {
            currentRentalFilter = type;
            
            // Update button styles
            document.getElementById('btn-all').style.background = type === 'all' ? '#4a90e2' : '#1e3a5f';
            document.getElementById('btn-dresses').style.background = type === 'Rental-Dresses' ? '#4a90e2' : '#1e3a5f';
            document.getElementById('btn-jewelry').style.background = type === 'Rental-Jewelry' ? '#4a90e2' : '#1e3a5f';
            
            if (type === 'all') {
                loadCategoryProducts('Rental-Dresses', 'Rental-Jewelry');
            } else {
                loadCategoryProducts(type);
            }
        }

        // Override search to work with rental categories
        function searchProducts() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const allProducts = JSON.parse(localStorage.getItem('customProducts')) || [];
            const rentalProds = allProducts.filter(p => p.category && p.category.startsWith('Rental-'));
            
            if (query) {
                const filtered = rentalProds.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    p.category.toLowerCase().includes(query)
                );
                displayProducts(filtered);
            } else {
                if (currentRentalFilter === 'all') {
                    loadCategoryProducts('Rental-Dresses', 'Rental-Jewelry');
                } else {
                    loadCategoryProducts(currentRentalFilter);
                }
            }
        }
    </script>
</body>
</html>
